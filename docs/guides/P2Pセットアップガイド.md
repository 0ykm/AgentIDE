# P2Pマルチノード セットアップガイド

複数のPC上でAgent IDEを起動し、1つのブラウザUIから全ノードのターミナル・ファイル・Git・Agentを操作するための手順。

---

## 前提条件

- 各PCが同一LAN（またはVPN）内にあること
- 各PC間でHTTP通信（デフォルト: ポート8787）が可能であること
- Node.js 20以上がインストール済み（ソースからビルドする場合）

---

## 1. バイナリのビルド

### ポータブル版（推奨）

```bash
make build-app-dir
```

ビルド成果物は `apps/desktop/dist/win-unpacked/` に生成される。このフォルダごとコピーすれば各PCで実行可能。

> **注意（Windows）**: ビルド中に `winCodeSign` のシンボリックリンクエラーが表示されることがあるが、実行ファイル（`Agent IDE.exe`）は正常に生成される。エラーメッセージは無視してよい。

### インストーラー版

```bash
make build-app
```

`apps/desktop/dist/` にインストーラー（`.exe`）が生成される。

### 開発モード（ビルド不要）

```bash
make dev
```

ブラウザで `http://localhost:5173` を開く。サーバーはポート8787で起動する。

---

## 2. 各PCへの配布と起動

### デスクトップアプリの場合

1. ビルド成果物（`win-unpacked/` フォルダまたはインストーラー）を各PCにコピー
2. `Agent IDE.exe` を起動
3. デフォルトでポート **8787** でサーバーが起動する

### ポート番号の変更

各ノードが異なるポートで動作する場合や、同一PCで複数ノードをテストする場合はポートを変更する。

**方法1: 設定画面から変更（デスクトップアプリ）**

画面左下の歯車アイコン（Settings）→ ポート番号を変更 → 保存 → アプリを再起動

**方法2: 環境変数で指定**

```bash
# デスクトップアプリ
DECK_IDE_PORT=8788 ./Deck\ IDE

# 開発モード（サーバー単体）
PORT=8788 DB_PATH=./data-node-b/agent-ide.db npm run dev:server
```

> `DB_PATH` を分けることで、同一PC上で複数のノードインスタンスを独立したデータベースで起動できる。

---

## 3. ファイアウォール設定

各PCでAgent IDEのポートへのアクセスを許可する。

**Windows:**
```
設定 → ネットワークとインターネット → Windows ファイアウォール → 受信の規則 → 新しい規則
→ ポート → TCP 8787 → 許可
```

**Linux:**
```bash
sudo ufw allow 8787/tcp
```

---

## 4. リモートノードの登録

操作PCのブラウザからリモートノードを登録する。

1. サイドバーの「**Nodes**」ボタンをクリック
2. 「**ノード追加**」ボタンをクリック
3. リモートPCのホスト名（またはIPアドレス）とポート番号を入力
4. 「**接続テスト**」ボタンで到達確認（成功するとノード名が自動取得される）
5. 「**追加**」ボタンで登録

登録後、ノード管理画面にリモートノードがステータス付きで表示される。

---

## 5. リモートDeckの作成と操作

1. Deckタブバーの「**+**」ボタンをクリック
2. デッキ作成モーダルで「**ノード**」ドロップダウンからリモートノードを選択
3. ワークスペース（リモートPC上のディレクトリ）を選択
4. デッキ名を入力（任意）して「**作成**」

作成されたリモートDeckはタブバーに表示され、ローカルDeckと同様にターミナル・ファイルツリー・Git・Agentが操作可能。

**Deck切替時の連動:**
- ファイルツリーはアクティブDeckのノードに自動的に切り替わる
- ターミナルはそのDeckのノード上で動作する
- Git操作もDeckに紐づくワークスペースに対して実行される

---

## 6. Basic認証の設定（任意）

ノードへのアクセスを制限する場合、各ノードでBasic認証を有効にする。

**デスクトップアプリ:**
Settings → Basic認証を有効化 → ユーザー名・パスワードを設定

**環境変数:**
```bash
BASIC_AUTH_USER=admin BASIC_AUTH_PASSWORD=yourpassword
```

リモートノード登録時に認証情報を入力すれば、認証付きノードにも接続できる。

---

## 構成例

### 2台構成

| ノード | PC | IP | ポート | 役割 |
|--------|-----|------|--------|------|
| Node A | 開発PC | 192.168.1.10 | 8787 | メインUI + ローカル作業 |
| Node B | ビルドPC | 192.168.1.20 | 8787 | リモートターミナル + ビルド |

Node AのブラウザからNode B（192.168.1.20:8787）を登録し、リモートDeckを作成して操作。

### 同一PC（テスト用）

```bash
# ターミナル1: Node A
PORT=8787 DB_PATH=./data-a/agent-ide.db npm run dev:server

# ターミナル2: Node B
PORT=8788 DB_PATH=./data-b/agent-ide.db npm run dev:server

# ターミナル3: フロントエンド
npm run dev:web
```

ブラウザで `http://localhost:5173` を開き、Node B（localhost:8788）を登録。

---

## トラブルシューティング

| 症状 | 原因と対処 |
|------|-----------|
| 接続テストが失敗する | リモートPCのファイアウォールでポートが閉じている。ポート開放を確認 |
| 接続テストが失敗する | リモートPCでAgent IDEが起動していない。サービスの起動を確認 |
| リモートターミナルが開かない | WebSocket接続がブロックされている。プロキシ・FW設定を確認 |
| ノードステータスが「オフライン」のまま | ネットワーク到達性を確認（`ping` / `curl http://<host>:<port>/api/node/info`） |
| デッキ作成時にワークスペースが表示されない | リモートノードにワークスペースが未登録。リモートノードで先にディレクトリを開いておく |
